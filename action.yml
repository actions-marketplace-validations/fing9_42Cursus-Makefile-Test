name: 42Cursus C/CPP Makefile Test

description: This workflow finds Makefiles in the repository and runs 'make' in each directory

branding:
  icon: 'check-circle'
  color: 'green'

on: push

inputs:
  dir:
    default: .

jobs:
  test-makefiles:
    runs-on: ubuntu-latest

    steps:
    - name: Set GitHub Path
      run: echo "$GITHUB_ACTION_PATH" >> $GITHUB_PATH
      shell: bash
      env:
        GITHUB_ACTION_PATH: ${{ github.action_path }}
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Find and run Makefiles
      run: |
        set -e
        for makefile in $(find ${{ inputs.dir }} -type f -name "Makefile"); do
          # Change to the directory containing the Makefile
          cd "$(dirname "$makefile")"
          # Run make command
          make
          # Check the exit code of make command
          if [ $? -ne 0 ]; then
            echo "Make failed in $(dirname "$makefile"). Exiting workflow."
            exit 1
          fi
          # Return to the original directory
          cd -
        done
      shell: bash
